<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <!-- 引入公共 CSS -->
    <link rel="stylesheet" href="css/global.css">
    
    <style>
        /* Profile 页面特有样式 */
        .profile-card { background: white; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; position: relative; }
        .card-bg { height: 90px; background: #33a8ff; }
        
        .card-avatar-container { position: absolute; top: 50px; left: 20px; }
        .card-avatar { width: 80px; height: 80px; border-radius: 6px; border: 4px solid white; background: #ddd; object-fit: cover; }
        
        .card-info { padding: 40px 12px 12px 12px; text-align: center; }
        .card-name { font-size: 22px; font-weight: bold; margin-bottom: 4px; }
        .card-meta { font-size: 12px; color: #787c7e; margin-bottom: 15px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; text-align: left; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .stat-label { font-size: 12px; color: #787c7e; }

        .btn-full { width: 100%; padding: 8px; background: #0079D3; color: white; border: none; border-radius: 99px; font-weight: bold; cursor: pointer; }
        /* 不同的按钮风格 */
        .btn-edit { background: white; border: 1px solid #0079D3; color: #0079D3; }
        .btn-edit:hover { background: #f2f8fc; }

        /* 设置弹窗里的样式 */
        .settings-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .settings-label { font-weight: bold; margin-bottom: 5px; display: block; font-size: 14px; }
    </style>
</head>
<body>

    <!-- 顶部导航占位 -->
    <div id="header-placeholder"></div>

    <div class="layout-container">
        <!-- 左侧导航占位 -->
        <div id="sidebar-placeholder"></div>

        <!-- 中间：发帖记录 -->
        <main class="main-feed">
            <h3 style="margin-bottom:15px; border-bottom:1px solid #edeff1; padding-bottom:10px;">Post History</h3>
            <div id="user-feed-list">Loading...</div>
        </main>

        <!-- 右侧：个人资料卡 -->
        <aside class="sidebar-right">
            <div class="profile-card">
                <div class="card-bg"></div>
                <div class="card-avatar-container">
                    <img id="p-avatar" class="card-avatar" src="">
                </div>
                <div class="card-info">
                    <div id="p-name" class="card-name">u/User</div>
                    <div id="p-date" class="card-meta">Redditor since ...</div>
                    
                    <hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">
                    
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-val" id="p-karma">0</span>
                            <span class="stat-label">Karma</span>
                        </div>
                    </div>

                    <!-- 按钮：如果是自己显示 Edit，如果是别人显示 Follow -->
                    <button id="profile-action-btn" class="btn-full" onclick="handleProfileAction()">Follow</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- 设置弹窗 (新增) -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-box" style="width: 400px;">
            <div class="modal-header">
                <span>Edit Profile</span>
                <span style="cursor:pointer" onclick="closeModal('settingsModal')">×</span>
            </div>
            
            <!-- 修改昵称 -->
            <div class="settings-section">
                <label class="settings-label">Display Name (Nickname)</label>
                <input type="text" id="set-nick" class="common-input" placeholder="New Nickname">
                <button class="primary-btn" style="width:auto; padding:5px 15px; font-size:12px;" onclick="saveNickname()">Save Name</button>
            </div>

            <!-- 修改密码 -->
            <div class="settings-section" style="border:none;">
                <label class="settings-label">Change Password</label>
                <input type="password" id="set-old-pass" class="common-input" placeholder="Old Password">
                <input type="password" id="set-new-pass" class="common-input" placeholder="New Password">
                <button class="primary-btn" style="width:auto; padding:5px 15px; font-size:12px; background:#ff4500;" onclick="savePassword()">Update Password</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        // 1. 获取 URL 参数
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('id'); // 目标用户ID
        let currentUserId = null; // 当前登录用户ID

        if(!targetUserId) { alert("No User ID"); location.href = "index.html"; }

        // 2. 初始化
        window.onload = async function() {
            await loadComponents();
            
            // 获取当前登录用户身份
            const res = await fetch('/api/auth/check');
            const d = await res.json();
            if(d.isLogin) {
                currentUserId = d.user.id.toString(); // 转字符串方便比较
            }

            // 加载目标用户数据
            loadUserProfile();
            loadUserPosts();
        };

        // 3. 加载资料卡
        async function loadUserProfile() {
            try {
                const res = await fetch(`/api/user/${targetUserId}`);
                const user = await res.json();
                
                if(!user) return;

                document.getElementById('p-name').innerText = "u/" + user.nickname;
                document.getElementById('p-avatar').src = user.avatar || 'https://example.com/default.png';
                document.getElementById('p-date').innerText = "Joined " + new Date(user.createdAt).toLocaleDateString();

                // === 关键逻辑：判断是不是本人 ===
                const btn = document.getElementById('profile-action-btn');
                if (currentUserId && currentUserId === targetUserId) {
                    // 是本人 -> 显示 "Edit Profile"
                    btn.innerText = "⚙️ Edit Profile";
                    btn.classList.add('btn-edit'); // 换个颜色
                    btn.onclick = () => openModal('settingsModal');
                    
                    // 预填昵称
                    document.getElementById('set-nick').value = user.nickname;
                } else {
                    // 是别人 -> 显示 "Follow" (占位)
                    btn.innerText = "Follow";
                    btn.onclick = () => alert("Follow 功能暂未开放");
                }

            } catch(e) { console.error(e); }
        }

        // 4. 加载发帖记录
        async function loadUserPosts() {
            const container = document.getElementById('user-feed-list');
            try {
                const res = await fetch(`/api/topic/user/${targetUserId}`);
                const list = await res.json();
                
                container.innerHTML = "";
                if(list.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No posts yet.</div>';
                    return;
                }

                let totalKarma = 0;
                list.forEach(topic => {
                    totalKarma += (topic.voteCount || 0);
                    // 简单的卡片渲染
                    const div = document.createElement('div');
                    div.className = 'post-card'; // 使用 global.css 里的样式
                    div.onclick = () => location.href = `topic_detail.html?id=${topic.id}`;
                    
                    let mediaHtml = "";
                    if(topic.mediaList && topic.mediaList.length > 0) {
                        // 简单显示第一张图
                        const m = topic.mediaList[0];
                        if(m.type==='IMAGE') mediaHtml = `<div style="height:200px; background:black; display:flex; justify-content:center; margin-bottom:10px;"><img src="${m.url}" style="height:100%"></div>`;
                    }

                    div.innerHTML = `
                        <div class="vote-column"><div>⇧</div><div style="font-weight:bold">${topic.voteCount||0}</div></div>
                        <div class="content-column">
                            <div style="font-size:12px; color:#787c7e;">r/${topic.category||'General'} • ${new Date(topic.createdAt).toLocaleDateString()}</div>
                            <div style="font-weight:bold; font-size:16px; margin:5px 0;">${topic.title}</div>
                            ${mediaHtml}
                        </div>
                    `;
                    container.appendChild(div);
                });
                document.getElementById('p-karma').innerText = totalKarma;

            } catch(e) { console.error(e); }
        }

        // 5. 修改资料逻辑
        async function saveNickname() {
            const newNick = document.getElementById('set-nick').value;
            if(!newNick) return;
            const res = await fetch('/api/user/update-info', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({nickname: newNick})
            });
            const d = await res.json();
            alert(d.msg);
            if(d.success) location.reload();
        }

        async function savePassword() {
            const oldP = document.getElementById('set-old-pass').value;
            const newP = document.getElementById('set-new-pass').value;
            if(!oldP || !newP) { alert("请填写完整"); return; }
            const res = await fetch('/api/user/update-password', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({oldPassword: oldP, newPassword: newP})
            });
            const d = await res.json();
            alert(d.msg);
            if(d.success) {
                closeModal('settingsModal');
                // 清空输入框
                document.getElementById('set-old-pass').value = "";
                document.getElementById('set-new-pass').value = "";
            }
        }
    </script>
</body>
</html>