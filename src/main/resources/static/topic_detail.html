<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¼•å…¥å…¬å…± CSS -->
    <link rel="stylesheet" href="css/global.css">
    <title>Post Details - ACG Reddit</title>
    <style>
        
       

        /* --- å¸–å­è¯¦æƒ…å¡ç‰‡ --- */
        .post-detail-card { background: var(--bg-card); border: 1px solid #ccc; border-radius: 4px; display: flex; margin-bottom: 20px; }
        .vote-column { width: 40px; background: white; display: flex; flex-direction: column; align-items: center; padding-top: 8px; border-right: 1px solid #edeff1; }
        .vote-btn { font-size: 24px; color: #878A8C; cursor: pointer; padding: 0 5px; }
        .vote-btn:hover { background: #eee; border-radius: 4px; }
        .vote-count { font-weight: bold; margin: 5px 0; font-size: 14px; }
        
        .content-column { flex: 1; padding: 10px 10px 10px 20px; }
        .post-header { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-meta); margin-bottom: 10px; }
        .subreddit-icon { width: 20px; height: 20px; border-radius: 50%; background: var(--color-primary); }
        .category-tag { background: #edeff1; color: var(--text-main); padding: 2px 8px; border-radius: 10px; font-weight: bold; }

        .post-title { font-size: 22px; font-weight: 500; margin-bottom: 15px; color: #222; }
        .post-text { font-size: 16px; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }

        /* åª’ä½“å±•ç¤º */
        .media-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .media-item { width: 100%; background: black; display: flex; justify-content: center; border-radius: 4px; overflow: hidden; }
        .media-item img, .media-item video { max-width: 100%; max-height: 700px; }

        /* --- è¯„è®ºåŒº --- */
        .comment-area { background: var(--bg-card); border: 1px solid #ccc; border-radius: 4px; padding: 20px 40px; }
        .comment-input-box { margin-bottom: 30px; }
        .c-textarea { width: 100%; height: 100px; border: 1px solid #edeff1; padding: 10px; border-radius: 4px; resize: none; margin-bottom: 10px; }
        .primary-btn { background: var(--color-blue); color: white; border: none; padding: 6px 20px; border-radius: 99px; font-weight: bold; cursor: pointer; }
        
        .comment-list { display: flex; flex-direction: column; gap: 15px; }
        .comment-item { display: flex; gap: 10px; }
        .c-avatar { width: 28px; height: 28px; border-radius: 50%; background: #ddd; object-fit: cover;}
        .c-main { flex: 1; }
        .c-meta { font-size: 12px; color: var(--text-meta); margin-bottom: 4px; }
        .c-body { font-size: 14px; line-height: 1.4; color: var(--text-main); }

        /* --- åµŒå¥—è¯„è®ºæ ·å¼ --- */
        /* æ¯ä¸€å±‚å›å¤éƒ½å¾€å³ç¼©è¿› 20pxï¼Œå¹¶åŠ ä¸€æ¡å·¦è¾¹æ¡†çº¿ */
        .replies-container {
            margin-left: 20px;
            border-left: 2px solid #edeff1;
            padding-left: 10px;
            margin-top: 10px;
        }
        
        /* è¯„è®ºåº•éƒ¨æ“ä½œåŒº */
        .comment-actions { display: flex; align-items: center; gap: 15px; margin-top: 5px; font-size: 12px; font-weight: bold; color: #787c7e; }
        .c-btn-text { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .c-btn-text:hover { background: #f2f4f5; border-radius: 4px; }
        
        /* è¯„è®ºç‚¹èµåŒºåŸŸ */
        .c-vote-box { display: flex; align-items: center; gap: 5px; }
        .c-arrow { font-size: 16px; cursor: pointer; padding: 0 4px; }
        .c-arrow:hover { color: #D93A00; background: #eee; border-radius: 2px; }
        .c-arrow.down:hover { color: #0079D3; }

        /* åŠ¨æ€ç”Ÿæˆçš„å›å¤è¾“å…¥æ¡† */
        .reply-input-box { margin-top: 10px; display: none; } /* é»˜è®¤éšè— */
        .reply-input-box.show { display: block; }


        /* ä¸Šä¼ å›¾ç‰‡æŒ‰é’®æ ·å¼ */
        .upload-icon-btn {
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            width: 30px; height: 30px; border-radius: 50%; color: #0079D3;
            transition: 0.2s;
        }
        .upload-icon-btn:hover { background-color: #f2f8fc; }
        
        /* é¢„è§ˆå›¾ç‰‡çš„æ ·å¼ */
        .comment-img-preview { max-width: 100px; max-height: 100px; margin-top: 5px; display: none; border-radius: 4px; border: 1px solid #ccc; }
        
        /* è¯„è®ºé‡Œæ˜¾ç¤ºçš„å¤§å›¾ */
        .comment-body-img { max-width: 100%; max-height: 400px; display: block; margin-top: 8px; border-radius: 4px; cursor: zoom-in; }


        @media (max-width: 1000px) { .sidebar-left { display: none; } .layout-container { grid-template-columns: 1fr 310px; } }
        @media (max-width: 700px) { .sidebar-right { display: none; } .layout-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

        <!-- é¡¶éƒ¨ -->
    <div id="header-placeholder"></div>

    <div class="layout-container">
        <!-- å·¦ä¾§ -->
        <div id="sidebar-placeholder"></div>





        <!-- ä¸­é—´å†…å®¹ -->
        <main>
            <!-- å¸–å­è¯¦æƒ…å¡ç‰‡ -->
            <div class="post-detail-card" id="post-container">
                <p style="padding: 20px;">Loading post...</p>
            </div>

            <!-- è¯„è®ºåŒº -->
            <div class="comment-area">
                <div class="comment-input-box">
                    <div style="font-size:14px; margin-bottom:5px;">Comment as <span id="current-user" style="color:var(--color-blue)">Guest</span></div>
                    
                    <textarea id="comment-text" class="c-textarea" placeholder="What are your thoughts?"></textarea>
                    
                    <!-- é¢„è§ˆåŒº -->
                    <img id="main-preview" class="comment-img-preview" src="">

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                        <!-- å›¾ç‰‡ä¸Šä¼ æŒ‰é’® -->
                        <div style="position: relative;">
                            <label class="upload-icon-btn" title="Add an image">
                                <svg fill="currentColor" height="20" viewBox="0 0 20 20" width="20"><path d="M18.121,9.227l-6.072-6.071c-0.293-0.293-0.768-0.293-1.061,0L4.917,9.227c-0.293,0.293-0.293,0.768,0,1.061l6.071,6.072c0.146,0.146,0.338,0.22,0.53,0.22s0.384-0.073,0.53-0.22l6.072-6.071C18.414,9.995,18.414,9.52,18.121,9.227z M11.53,15.28l-5.011-5.011l5.011-5.011l5.011,5.011L11.53,15.28z M12.591,7.636c-0.828,0-1.5,0.672-1.5,1.5c0,0.828,0.672,1.5,1.5,1.5c0.828,0,1.5-0.672,1.5-1.5C14.091,8.308,13.419,7.636,12.591,7.636z"></path><path d="M16 0H4C1.79 0 0 1.79 0 4v12c0 2.21 1.79 4 4 4h12c2.21 0 4-1.79 4-4V4c0-2.21-1.79-4-4-4zm-1 4v4h-3V4h3zm-4 0v4H7V4h4zM4 2h12c1.1 0 2 .9 2 2v1h-3v5h3v6H4V10h3V5H4V4c0-1.1.9-2 2-2z"></path><path d="M19 13h-2v2h2v-2zm0-4h-2v2h2V9z"></path></svg>
                                <!-- éšè—çš„ input -->
                                <input type="file" id="main-file" style="display: none;" accept="image/*" onchange="previewImage(this, 'main-preview')">
                            </label>
                        </div>

                        <button class="primary-btn" onclick="postComment()">Comment</button>
                    </div>
                </div>
                <div id="comment-list" class="comment-list"></div>
            </div>
        </main>

        <!-- å³ä¾§å ä½ -->
        <div id="right-placeholder"></div>
    </div>

    <script src="js/common.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const topicId = urlParams.get('id');
        if (!topicId) location.href = "index.html";

        // ã€æ–°å¢ã€‘å…¨å±€å˜é‡å­˜å½“å‰ç”¨æˆ·ID
        let currentUserId = null; 
        //å¯¼å…¥é¡¶éƒ¨æ 
        window.onload = async function() {
            // 1. å…ˆåŠ è½½é¡¶éƒ¨æ ç»„ä»¶
            await loadComponents();
            // ã€æ–°å¢ã€‘å…ˆè·å–å½“å‰ç™»å½•ç”¨æˆ·
            try {
                const res = await fetch('/api/auth/check');
                const d = await res.json();
                if(d.isLogin) {
                    currentUserId = d.user.id;
                }
            } catch(e){}
            // 2. ç„¶åå†åŠ è½½æœ¬é¡µé¢çš„æ•°æ®
            loadTopic();
            loadComments();
        };

        // --- åŠ è½½å¸–å­è¯¦æƒ… ---
        async function loadTopic() {
            try {
                const res = await fetch('/api/topic/' + topicId);
                const data = await res.json();
                
                if(!data || !data.title) { document.getElementById('post-container').innerText = "Post not found"; return; }

                // æ¸²æŸ“åª’ä½“
                let mediaHtml = '';
                if(data.mediaList && data.mediaList.length > 0) {
                    mediaHtml = '<div class="media-container">';
                    data.mediaList.forEach(m => {
                        if(m.type === 'VIDEO') mediaHtml += `<div class="media-item"><video controls src="${m.url}"></video></div>`;
                        else mediaHtml += `<div class="media-item"><img src="${m.url}"></div>`;
                    });
                    mediaHtml += '</div>';
                }

                // æ¸²æŸ“æ•´ä¸ªå¡ç‰‡
                const author = data.author ? data.author.nickname : 'u/Unknown';
                const time = new Date(data.createdAt).toLocaleDateString();
                const votes = data.voteCount || 0;
                // åˆ†ç±» (é»˜è®¤ General)
                const category = data.category || 'General';

                // ã€æ–°å¢ã€‘åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                let deleteBtnHtml = '';
                // data.author å¯èƒ½ä¸º null (å¦‚æœç”¨æˆ·æ³¨é”€äº†)ï¼Œè¦åšä¿æŠ¤
                if (currentUserId && data.author && currentUserId === data.author.id) {
                    deleteBtnHtml = `<span style="color:red; cursor:pointer; font-size:12px; margin-left:15px; font-weight:bold;" onclick="deleteTopic()">ğŸ—‘ Delete Post</span>`;
                }
                document.getElementById('post-container').innerHTML = `
                    <div class="vote-column">
                        <div class="vote-btn" onclick="vote(1)">â‡§</div>
                        <div class="vote-count" id="detail-vote-count">${votes}</div>
                        <div class="vote-btn" onclick="vote(-1)">â‡©</div>
                    </div>
                    <div class="content-column">
                        <div class="post-header">
                            <div class="subreddit-icon"></div>
                            <span style="font-weight:bold; color:black;">r/${category}</span>
                            <span>â€¢ Posted by u/${author}</span>
                            <span>${time}</span>
                            <span class="category-tag">${category}</span>
                            <!-- ã€æ–°å¢ã€‘æ’å…¥åˆ é™¤æŒ‰é’® -->
                            ${deleteBtnHtml}
                        </div>
                        <div class="post-title">${data.title}</div>
                        ${mediaHtml}
                        <div class="post-text">${data.content}</div>
                    </div>
                `;
            } catch(e) { console.error(e); }
        }

        // --- æŠ•ç¥¨é€»è¾‘ (å¤ç”¨) ---
        async function vote(type) {
            try {
                const res = await fetch('/api/vote/toggle', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({topicId: topicId, type: type})
                });
                const d = await res.json();
                if(d.success) {
                    document.getElementById('detail-vote-count').innerText = d.newScore;
                } else {
                    alert(d.msg);
                }
            } catch(e){}
        }

        // --- åŠ è½½è¯„è®º ---
        async function loadComments() {
            try {
                const res = await fetch('/api/comment/list?topicId=' + topicId);
                let list = await res.json();
                const container = document.getElementById('comment-list');
                container.innerHTML = ""; 

                if (list.length === 0) {
                    container.innerHTML = '<p style="color:#999; text-align:center;">æš‚æ— è¯„è®º</p>';
                    return;
                }

                // ã€æ ¸å¿ƒé€»è¾‘ã€‘åªæ¸²æŸ“â€œæ ¹è¯„è®ºâ€ (parent ä¸º null çš„)
                // å­è¯„è®ºä¼šåŒ…å«åœ¨æ ¹è¯„è®ºçš„ replies å­—æ®µé‡Œ (JPA è‡ªåŠ¨å¸®æˆ‘ä»¬ç»„è£…å¥½äº†)
                // ä½†è¦æ³¨æ„ï¼šåç«¯å¦‚æœç›´æ¥è¿”å›æ‰€æœ‰ listï¼Œæˆ‘ä»¬éœ€è¦ç­›é€‰ä¸€ä¸‹
                const rootComments = list.filter(c => c.parent === null);

                rootComments.forEach(c => {
                    container.appendChild(createCommentNode(c));
                });

            } catch(e) { console.error(e); }
        }


         // --- ä¿®æ”¹ï¼šå‘é€ä¸»è¯„è®º ---
        async function postComment() {
            const txt = document.getElementById('comment-text').value;
            const fileInput = document.getElementById('main-file');
            
            if(!txt && fileInput.files.length === 0) return; // æ—¢æ²¡å­—ä¹Ÿæ²¡å›¾

            const fd = new FormData();
            fd.append('topicId', topicId);
            fd.append('content', txt || ' '); // å¦‚æœåªå‘å›¾ï¼Œæ–‡å­—ä¼ ä¸ªç©ºæ ¼é˜²æ­¢æŠ¥é”™
            if (fileInput.files[0]) {
                fd.append('file', fileInput.files[0]);
            }

            try {
                // æ³¨æ„ï¼šå‘é€ FormData æ—¶ä¸éœ€è¦è®¾ç½® Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è¯†åˆ«
                const res = await fetch('/api/comment/add', {
                    method: 'POST', 
                    body: fd 
                });
                const d = await res.json();
                if(d.success) {
                    // æ¸…ç©ºè¾“å…¥æ¡†å’Œé¢„è§ˆ
                    document.getElementById('comment-text').value = "";
                    fileInput.value = ""; 
                    document.getElementById('main-preview').style.display = 'none';
                    loadComments();
                } else { alert(d.msg); }
            } catch(e){ console.error(e); }
        }

        // --- ä¿®æ”¹ï¼šæ¸²æŸ“è¯„è®ºèŠ‚ç‚¹ (æ˜¾ç¤ºå›¾ç‰‡) ---
        function createCommentNode(c) {
            // ... (å¤´åƒã€æ˜µç§°ä»£ç ä¸å˜) ...
            const avatar = c.user && c.user.avatar ? c.user.avatar : 'https://example.com/default.png';
            const nick = c.user ? c.user.nickname : 'User';
            const date = new Date(c.createdAt).toLocaleString();

            const div = document.createElement('div');
            div.className = 'comment-item';
            div.style.flexDirection = 'column';

            // ã€æ–°å¢ã€‘å›¾ç‰‡ HTML ç”Ÿæˆ
            let commentImgHtml = '';
            if (c.imageUrl) {
                commentImgHtml = `<img src="${c.imageUrl}" class="comment-body-img" onclick="window.open(this.src)">`;
            }

            div.innerHTML = `
                <div style="display:flex; gap:10px;">
                    <img src="${avatar}" class="c-avatar">
                    <div class="c-main">
                        <div class="c-meta">${nick} â€¢ ${date}</div>
                        <div class="c-body">
                            ${c.content}
                            ${commentImgHtml} <!-- æ’å…¥å›¾ç‰‡ -->
                        </div>
                        
                        <!-- æ“ä½œæ ï¼šæŠ•ç¥¨ + å›å¤ + åˆ é™¤ -->
                        <div class="comment-actions">
                            <div class="c-vote-box">
                                <span class="c-arrow" onclick="voteComment(${c.id}, 1)">â‡§</span>
                                <span id="c-score-${c.id}">${c.voteCount || 0}</span>
                                <span class="c-arrow down" onclick="voteComment(${c.id}, -1)">â‡©</span>
                            </div>
                            <span style="border-right:1px solid #ddd; height:14px;"></span>
                            <span class="c-btn-text" onclick="toggleReplyBox(${c.id})">ğŸ’¬ Reply</span>
                            <!-- ã€æ–°å¢ã€‘åˆ é™¤æŒ‰é’®é€»è¾‘ -->
                            ${ (currentUserId && c.user && currentUserId === c.user.id) ? 
                                `<span class="c-btn-text" style="color:#ff4500;" onclick="deleteComment(${c.id})">ğŸ—‘ Delete</span>` : '' }
                        </div>

                        <!-- å›å¤æ¡† (éœ€è¦å¢åŠ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½) -->
                        <div id="reply-box-${c.id}" class="reply-input-box">
                            <textarea id="reply-text-${c.id}" class="c-textarea" style="height:60px;" placeholder="Reply to ${nick}..."></textarea>
                            
                            <!-- å›å¤é‡Œçš„å›¾ç‰‡é¢„è§ˆ -->
                            <img id="reply-preview-${c.id}" class="comment-img-preview" src="">
                            
                            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                                <label class="upload-icon-btn" title="Add image">
                                    ğŸ“· <!-- æ‡’å¾—å¤åˆ¶SVGäº†ï¼Œç”¨Emojiä»£æ›¿ -->
                                    <input type="file" id="reply-file-${c.id}" style="display:none;" accept="image/*" onchange="previewImage(this, 'reply-preview-${c.id}')">
                                </label>
                                <button class="primary-btn" style="font-size:12px; padding:4px 12px;" onclick="postReply(${c.id})">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // ã€é€’å½’ã€‘å¦‚æœæœ‰å­å›å¤ï¼Œåˆ›å»ºä¸€ä¸ªå®¹å™¨å¹¶æŠŠå­å›å¤å¡è¿›å»
            if (c.replies && c.replies.length > 0) {
                const repliesDiv = document.createElement('div');
                repliesDiv.className = 'replies-container';
                
                // é€’å½’è°ƒç”¨è‡ªå·±
                c.replies.forEach(reply => {
                    repliesDiv.appendChild(createCommentNode(reply));
                });
                
                div.appendChild(repliesDiv);
            }

            return div;
        }

        // --- äº¤äº’ï¼šæ˜¾ç¤º/éšè—å›å¤æ¡† ---
        function toggleReplyBox(commentId) {
            const box = document.getElementById(`reply-box-${commentId}`);
            if (box.classList.contains('show')) {
                box.classList.remove('show');
            } else {
                // å…³é—­å…¶ä»–æ‰€æœ‰å›å¤æ¡† (å¯é€‰ä½“éªŒä¼˜åŒ–)
                document.querySelectorAll('.reply-input-box').forEach(el => el.classList.remove('show'));
                box.classList.add('show');
            }
        }

        // --- ä¿®æ”¹ï¼šå‘é€å›å¤ (æ”¯æŒå›¾ç‰‡) ---
        async function postReply(parentId) {
            const txt = document.getElementById(`reply-text-${parentId}`).value;
            const fileInput = document.getElementById(`reply-file-${parentId}`);
            
            if(!txt && fileInput.files.length === 0) return;

            const fd = new FormData();
            fd.append('topicId', topicId);
            fd.append('parentId', parentId);
            fd.append('content', txt || ' ');
            if (fileInput.files[0]) {
                fd.append('file', fileInput.files[0]);
            }

            try {
                const res = await fetch('/api/comment/add', { method: 'POST', body: fd });
                const d = await res.json();
                if(d.success) {
                    loadComments();
                } else { alert(d.msg); }
            } catch(e) { alert("Error"); }
        }

        // æ£€æŸ¥å½“å‰ç™»å½•ç”¨æˆ·
        fetch('/api/auth/check').then(r=>r.json()).then(d=>{
            if(d.isLogin) document.getElementById('current-user').innerText = d.user.nickname;
        });

        loadTopic();
        loadComments();

        // --- äº¤äº’ï¼šç»™è¯„è®ºæŠ•ç¥¨ ---
        async function voteComment(commentId, type) {
            try {
                const res = await fetch('/api/vote/comment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        commentId: commentId,
                        type: type
                    })
                });
                const d = await res.json();
                
                if(d.success) {
                    // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„æ•°å­—
                    document.getElementById(`c-score-${commentId}`).innerText = d.newScore;
                    // å¯é€‰ï¼šç»™æ•°å­—å˜ä¸ªè‰²
                    const scoreEl = document.getElementById(`c-score-${commentId}`);
                    scoreEl.style.color = type === 1 ? '#D93A00' : '#0079D3';
                } else {
                    alert(d.msg);
                }
            } catch(e) { console.error(e); }
        }

        // --- å·¥å…·ï¼šå›¾ç‰‡é¢„è§ˆ ---
        function previewImage(input, imgId) {
            const preview = document.getElementById(imgId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // --- åˆ é™¤å¸–å­ ---
        async function deleteTopic() {
            if(!confirm("Are you sure you want to delete this post? This cannot be undone.")) return;
            
            try {
                const res = await fetch(`/api/topic/delete/${topicId}`, { method: 'DELETE' });
                const d = await res.json();
                if(d.success) {
                    alert("Deleted successfully.");
                    window.location.href = "index.html"; // åˆ å®Œå›é¦–é¡µ
                } else {
                    alert(d.msg);
                }
            } catch(e) { alert("Error"); }
        }

        // --- åˆ é™¤è¯„è®º ---
        async function deleteComment(cid) {
            if(!confirm("Delete this comment?")) return;

            try {
                const res = await fetch('/api/comment/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ commentId: cid })
                });
                const d = await res.json();
                if(d.success) {
                    loadComments(); // åˆ·æ–°åˆ—è¡¨ï¼Œæ˜¾ç¤º "[å·²åˆ é™¤]"
                } else {
                    alert(d.msg);
                }
            } catch(e) { alert("Error"); }
        }
    </script>
</body>
</html>