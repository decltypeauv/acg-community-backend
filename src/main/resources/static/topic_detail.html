<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Details - ACG Reddit</title>
    <style>
        /* --- æ ¸å¿ƒå˜é‡ (å’Œé¦–é¡µä¿æŒä¸€è‡´) --- */
        :root {
            --bg-body: #DAE0E6; --bg-card: #FFFFFF; --text-main: #1c1c1c; --text-meta: #787c7e;
            --color-primary: #D93A00; --color-blue: #0079D3; --hover-bg: #f6f7f8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); padding-top: 50px; }
        a { text-decoration: none; color: inherit; cursor: pointer; }

        /* --- å¯¼èˆªæ  (å¤ç”¨é¦–é¡µæ ·å¼) --- */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: 48px; background: var(--bg-card); border-bottom: 1px solid #edeff1; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
        .nav-logo { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 18px; }
        .nav-logo-icon { width: 32px; height: 32px; background: var(--color-primary); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; }
        .nav-search { flex: 1; max-width: 600px; margin: 0 20px; }
        .search-input { width: 100%; height: 32px; background: #F6F7F8; border: 1px solid #EDEFF1; border-radius: 16px; padding: 0 16px; outline: none; }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .layout-container { display: grid; grid-template-columns: 270px 1fr 310px; gap: 24px; max-width: 1600px; margin: 20px auto; padding: 0 24px; }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar-left { display: flex; flex-direction: column; gap: 5px; font-size: 14px; 
                        position: sticky;/* å¼€å¯ç²˜æ€§å®šä½ */top: 60px;/* è·ç¦»é¡¶éƒ¨ 60px æ—¶åœä½ (å› ä¸ºé¡¶éƒ¨å¯¼èˆªæ çº¦ 50px) */
                        height: fit-content;/* é«˜åº¦ä»…åŒ…è£¹å†…å®¹ï¼Œä¸è¦æ’‘æ»¡å…¨å±ï¼Œå¦åˆ™ sticky æ²¡æ³•åŠ¨ */}
        .nav-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; color: var(--text-main); }
        .nav-item:hover { background-color: var(--hover-bg); }
        .sidebar-right { display: flex; flex-direction: column; gap: 16px; 
                        position: sticky;/* å¼€å¯ç²˜æ€§å®šä½ */top: 60px;/* è·ç¦»é¡¶éƒ¨ 60px æ—¶åœä½ (å› ä¸ºé¡¶éƒ¨å¯¼èˆªæ çº¦ 50px) */
                        height: fit-content;/* é«˜åº¦ä»…åŒ…è£¹å†…å®¹ï¼Œä¸è¦æ’‘æ»¡å…¨å±ï¼Œå¦åˆ™ sticky æ²¡æ³•åŠ¨ */}
        .widget-box { background: var(--bg-card); border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .widget-header { background: var(--color-blue); color: white; padding: 10px; font-weight: bold; }
        .widget-content { padding: 12px; }

        /* --- å¸–å­è¯¦æƒ…å¡ç‰‡ --- */
        .post-detail-card { background: var(--bg-card); border: 1px solid #ccc; border-radius: 4px; display: flex; margin-bottom: 20px; }
        .vote-column { width: 40px; background: white; display: flex; flex-direction: column; align-items: center; padding-top: 8px; border-right: 1px solid #edeff1; }
        .vote-btn { font-size: 24px; color: #878A8C; cursor: pointer; padding: 0 5px; }
        .vote-btn:hover { background: #eee; border-radius: 4px; }
        .vote-count { font-weight: bold; margin: 5px 0; font-size: 14px; }
        
        .content-column { flex: 1; padding: 10px 10px 10px 20px; }
        .post-header { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-meta); margin-bottom: 10px; }
        .subreddit-icon { width: 20px; height: 20px; border-radius: 50%; background: var(--color-primary); }
        .category-tag { background: #edeff1; color: var(--text-main); padding: 2px 8px; border-radius: 10px; font-weight: bold; }

        .post-title { font-size: 22px; font-weight: 500; margin-bottom: 15px; color: #222; }
        .post-text { font-size: 16px; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }

        /* åª’ä½“å±•ç¤º */
        .media-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .media-item { width: 100%; background: black; display: flex; justify-content: center; border-radius: 4px; overflow: hidden; }
        .media-item img, .media-item video { max-width: 100%; max-height: 700px; }

        /* --- è¯„è®ºåŒº --- */
        .comment-area { background: var(--bg-card); border: 1px solid #ccc; border-radius: 4px; padding: 20px 40px; }
        .comment-input-box { margin-bottom: 30px; }
        .c-textarea { width: 100%; height: 100px; border: 1px solid #edeff1; padding: 10px; border-radius: 4px; resize: none; margin-bottom: 10px; }
        .primary-btn { background: var(--color-blue); color: white; border: none; padding: 6px 20px; border-radius: 99px; font-weight: bold; cursor: pointer; }
        
        .comment-list { display: flex; flex-direction: column; gap: 15px; }
        .comment-item { display: flex; gap: 10px; }
        .c-avatar { width: 28px; height: 28px; border-radius: 50%; background: #ddd; object-fit: cover;}
        .c-main { flex: 1; }
        .c-meta { font-size: 12px; color: var(--text-meta); margin-bottom: 4px; }
        .c-body { font-size: 14px; line-height: 1.4; color: var(--text-main); }

        @media (max-width: 1000px) { .sidebar-left { display: none; } .layout-container { grid-template-columns: 1fr 310px; } }
        @media (max-width: 700px) { .sidebar-right { display: none; } .layout-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="nav-logo">
            <div class="nav-logo-icon">A</div>
            <span>ACG Reddit</span>
        </a>
        <div class="nav-search"><input type="text" class="search-input" placeholder="Search"></div>
        <div style="font-size:12px; font-weight:bold; color:var(--text-meta);">Welcome</div>
    </nav>

    <div class="layout-container">
        <!-- å·¦ä¾§å¯¼èˆª -->
        <aside class="sidebar-left">
            <div class="nav-item" onclick="location.href='index.html'">ğŸ  Home</div>
            <div class="nav-item">ğŸ”¥ Popular</div>
            <div class="nav-item">ğŸ“º Anime</div>
        </aside>

        <!-- ä¸­é—´å†…å®¹ -->
        <main>
            <!-- å¸–å­è¯¦æƒ…å¡ç‰‡ -->
            <div class="post-detail-card" id="post-container">
                <p style="padding: 20px;">Loading post...</p>
            </div>

            <!-- è¯„è®ºåŒº -->
            <div class="comment-area">
                <div class="comment-input-box">
                    <div style="font-size:14px; margin-bottom:5px;">Comment as <span id="current-user" style="color:var(--color-blue)">Guest</span></div>
                    <textarea id="comment-text" class="c-textarea" placeholder="What are your thoughts?"></textarea>
                    <div style="text-align: right;">
                        <button class="primary-btn" onclick="postComment()">Comment</button>
                    </div>
                </div>
                <div id="comment-list" class="comment-list"></div>
            </div>
        </main>

        <!-- å³ä¾§ -->
        <aside class="sidebar-right">
            <div class="widget-box">
                <div class="widget-header">r/ACGForum</div>
                <div class="widget-content">
                    <p>Your daily dose of Anime, Comics, and Games.</p>
                    <button class="primary-btn" style="width:100%; margin-top:10px;" onclick="location.href='index.html'">Back to Home</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const topicId = urlParams.get('id');
        if (!topicId) location.href = "index.html";

        // --- åŠ è½½å¸–å­è¯¦æƒ… ---
        async function loadTopic() {
            try {
                const res = await fetch('/api/topic/' + topicId);
                const data = await res.json();
                
                if(!data || !data.title) { document.getElementById('post-container').innerText = "Post not found"; return; }

                // æ¸²æŸ“åª’ä½“
                let mediaHtml = '';
                if(data.mediaList && data.mediaList.length > 0) {
                    mediaHtml = '<div class="media-container">';
                    data.mediaList.forEach(m => {
                        if(m.type === 'VIDEO') mediaHtml += `<div class="media-item"><video controls src="${m.url}"></video></div>`;
                        else mediaHtml += `<div class="media-item"><img src="${m.url}"></div>`;
                    });
                    mediaHtml += '</div>';
                }

                // æ¸²æŸ“æ•´ä¸ªå¡ç‰‡
                const author = data.author ? data.author.nickname : 'u/Unknown';
                const time = new Date(data.createdAt).toLocaleDateString();
                const votes = data.voteCount || 0;
                // åˆ†ç±» (é»˜è®¤ General)
                const category = data.category || 'General';

                document.getElementById('post-container').innerHTML = `
                    <div class="vote-column">
                        <div class="vote-btn" onclick="vote(1)">â‡§</div>
                        <div class="vote-count" id="detail-vote-count">${votes}</div>
                        <div class="vote-btn" onclick="vote(-1)">â‡©</div>
                    </div>
                    <div class="content-column">
                        <div class="post-header">
                            <div class="subreddit-icon"></div>
                            <span style="font-weight:bold; color:black;">r/${category}</span>
                            <span>â€¢ Posted by u/${author}</span>
                            <span>${time}</span>
                            <span class="category-tag">${category}</span>
                        </div>
                        <div class="post-title">${data.title}</div>
                        ${mediaHtml}
                        <div class="post-text">${data.content}</div>
                    </div>
                `;
            } catch(e) { console.error(e); }
        }

        // --- æŠ•ç¥¨é€»è¾‘ (å¤ç”¨) ---
        async function vote(type) {
            try {
                const res = await fetch('/api/vote/toggle', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({topicId: topicId, type: type})
                });
                const d = await res.json();
                if(d.success) {
                    document.getElementById('detail-vote-count').innerText = d.newScore;
                } else {
                    alert(d.msg);
                }
            } catch(e){}
        }

        // --- åŠ è½½è¯„è®º ---
        async function loadComments() {
            const res = await fetch('/api/comment/list?topicId=' + topicId);
            const list = await res.json();
            const box = document.getElementById('comment-list');
            box.innerHTML = "";
            list.forEach(c => {
                const avatar = c.user && c.user.avatar ? c.user.avatar : 'https://example.com/default.png';
                const nick = c.user ? c.user.nickname : 'User';
                const date = new Date(c.createdAt).toLocaleString();
                
                box.innerHTML += `
                    <div class="comment-item">
                        <img src="${avatar}" class="c-avatar">
                        <div class="c-main">
                            <div class="c-meta">${nick} â€¢ ${date}</div>
                            <div class="c-body">${c.content}</div>
                        </div>
                    </div>
                `;
            });
        }

        // --- å‘è¯„è®º ---
        async function postComment() {
            const txt = document.getElementById('comment-text').value;
            if(!txt) return;
            try {
                const res = await fetch('/api/comment/add', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({topicId: topicId, content: txt})
                });
                const d = await res.json();
                if(d.success) {
                    document.getElementById('comment-text').value = "";
                    loadComments();
                } else { alert(d.msg); }
            } catch(e){}
        }

        // æ£€æŸ¥å½“å‰ç™»å½•ç”¨æˆ·
        fetch('/api/auth/check').then(r=>r.json()).then(d=>{
            if(d.isLogin) document.getElementById('current-user').innerText = d.user.nickname;
        });

        loadTopic();
        loadComments();
    </script>
</body>
</html>