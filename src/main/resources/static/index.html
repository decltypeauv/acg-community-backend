<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACG Reddit - é¦–é¡µ</title>
    
    <!-- âœ… å…³é”®ï¼šç¡®ä¿è¿™è¡Œå¼•å…¥äº† global.css -->
    <link rel="stylesheet" href="css/global.css">

    <!-- è¿™é‡Œçš„ <style> å¯ä»¥ä¿ç•™ä¸€äº›â€œä»…é¦–é¡µç‰¹æœ‰â€çš„å¾®è°ƒï¼Œå¦‚æœæ²¡æœ‰å°±ä¸å†™ -->
    <style>
        /* ç›®å‰çœ‹æ¥ï¼Œé¦–é¡µçš„æ‰€æœ‰æ ·å¼ï¼ˆå¡ç‰‡ã€ä¾§è¾¹æ ã€æ’åºæ¡ï¼‰éƒ½å·²ç»æ˜¯é€šç”¨çš„äº†ã€‚
           æ‰€ä»¥è¿™é‡Œå¯ä»¥æ˜¯ç©ºçš„ï¼Œç”šè‡³ç›´æ¥æŠŠ <style> æ ‡ç­¾åˆ æ‰ï¼ */
    </style>
</head>
<body>

    <!-- å¯¼èˆªæ  -->
    <div id="header-placeholder"></div>
    <!-- ä¸»å¸ƒå±€ -->
    <div class="layout-container">
        <!-- å·¦ä¾§ -->
        <aside class="sidebar-left">
            <div class="nav-item" onclick="loadFeed('All')">ğŸ  Home</div>
            <div class="nav-item" onclick="loadFeed(undefined, 'Top')">ğŸ”¥ Popular</div>
            <div class="section-header">TOPICS</div>
            <div class="nav-item" onclick="loadFeed('Game')">ğŸ® Gaming</div>
            <div class="nav-item" onclick="loadFeed('Anime')">ğŸ“º Anime</div>
            <div class="nav-item" onclick="loadFeed('Art')">ğŸ¨ Art</div>
        </aside>

        <!-- ä¸­é—´ -->
        <main class="main-feed">
            <div class="sort-bar">
                <button class="sort-btn active" onclick="loadFeed(undefined, 'Top')">Hot</button>
                <button class="sort-btn" onclick="loadFeed(undefined, 'New')">New</button>
                <button class="sort-btn" onclick="loadFeed(undefined, 'Top')">Top</button>
            </div>
            <div id="feed-list">Loading...</div>
        </main>

        <!-- å³ä¾§å ä½ (æ–°å¢) -->
        <div id="right-placeholder"></div>

    <!-- å¼¹çª— -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-box" style="width: 350px;">
            <div class="modal-header"><span>Log In</span><span style="cursor:pointer" onclick="closeModal('loginModal')">Ã—</span></div>
            <input type="text" id="l-user" class="common-input" placeholder="Username">
            <input type="password" id="l-pass" class="common-input" placeholder="Password">
            <button class="primary-btn" onclick="doLogin()">Login</button>
            <div style="font-size:12px; margin-top:10px;">New user? <span style="color:#0079D3; cursor:pointer;" onclick="switchModal('loginModal','registerModal')">Sign up</span></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="registerModal">
        <div class="modal-box" style="width: 350px;">
            <div class="modal-header"><span>Sign Up</span><span style="cursor:pointer" onclick="closeModal('registerModal')">Ã—</span></div>
            <input type="text" id="r-user" class="common-input" placeholder="Username">
            <input type="text" id="r-nick" class="common-input" placeholder="Nickname">
            <input type="password" id="r-pass" class="common-input" placeholder="Password">
            <button class="primary-btn" onclick="doRegister()">Sign Up</button>
            <div style="font-size:12px; margin-top:10px;">Has account? <span style="color:#0079D3; cursor:pointer;" onclick="switchModal('registerModal','loginModal')">Log in</span></div>
        </div>
    </div>

    <div class="modal-overlay" id="publishModal">
        <div class="modal-box" style="width: 600px;">
            <div class="modal-header"><span>Create Post</span><span style="cursor:pointer" onclick="closeModal('publishModal')">Ã—</span></div>
            <select id="p-category" class="common-input" style="background: white;">
                <option value="General">General</option>
                <option value="Anime">ğŸ“º Anime</option>
                <option value="Game">ğŸ® Game</option>
                <option value="Art">ğŸ¨ Art</option>
            </select>
            <input type="text" id="p-title" class="common-input" placeholder="Title">
            <textarea id="p-content" class="common-input" style="height:120px; resize:none;" placeholder="Text (optional)"></textarea>
            <input type="file" id="p-files" multiple style="margin-bottom:10px;">
            <button class="primary-btn" onclick="doPublish()">Post</button>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        
        // --- 1. å…¨å±€çŠ¶æ€ ---
        let currentCategory = 'All';
        let currentSort = 'New';
        let currentKeyword = '';

        window.onload = async function() {
                // 1. å…ˆåŠ è½½å…¬å…±å¤´å’Œä¾§è¾¹æ 
            await loadComponents();
            
            // 2. å†åŠ è½½å¸–å­åˆ—è¡¨ (æŠŠä¹‹å‰çš„ loadFeed è°ƒç”¨æ”¾åˆ°è¿™é‡Œ)
            checkLogin(); // å…¶å® common.js é‡Œä¹Ÿä¼šè°ƒï¼Œå¤šè°ƒä¸€æ¬¡æ— å¦¨ï¼Œæˆ–è€…åˆ æ‰è¿™è¡Œ
            loadFeed();
        };

        // --- 2. åŸºç¡€äº¤äº’ ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function switchModal(c, o) { closeModal(c); openModal(o); }
        function checkLoginAndOpenPublish() {
            if(document.getElementById('guest-nav').style.display !== 'none') openModal('loginModal');
            else openModal('publishModal');
        }
        
        // èœå•åˆ‡æ¢
        function toggleUserMenu(e) {
            e.stopPropagation();
            document.getElementById('user-menu').classList.toggle('show');
        }
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('user-menu');
            const btn = document.getElementById('user-nav');
            if(menu.classList.contains('show') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });




        async function doPublish() {
            const t = document.getElementById('p-title').value;
            const cat = document.getElementById('p-category').value;
            const c = document.getElementById('p-content').value;
            const f = document.getElementById('p-files');
            const fd = new FormData(); 
            fd.append('title', t); fd.append('content', c); fd.append('category', cat);
            for(let file of f.files) fd.append('files', file);
            
            const btn = document.querySelector('#publishModal .primary-btn');
            btn.innerText = "Posting..."; btn.disabled = true;
            try {
                const res = await fetch('/api/topic/publish', { method:'POST', body:fd });
                const d = await res.json();
                if(d.success) location.reload(); else { alert(d.msg); btn.disabled=false; btn.innerText="Post"; }
            } catch(e){ alert("Error"); btn.disabled=false; btn.innerText="Post"; }
        }

        async function vote(e, topicId, type) {
            e.stopPropagation();
            const countEl = document.getElementById(`vote-count-${topicId}`);
            try {
                const res = await fetch('/api/vote/toggle', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ topicId: topicId, type: type })
                });
                const d = await res.json();
                if(d.success) {
                    countEl.innerText = d.newScore;
                    countEl.style.color = type === 1 ? '#D93A00' : '#0079D3';
                } else alert(d.msg);
            } catch(e) {}
        }

        // --- 5. åŠ è½½åˆ—è¡¨ ---
        async function loadFeed(category, sort, keyword) {
            const container = document.getElementById('feed-list');
            if (category !== undefined) currentCategory = category;
            if (sort !== undefined) currentSort = sort;
            if (keyword !== undefined) currentKeyword = keyword;

            // Highlight UI
            document.querySelectorAll('.sidebar-left .nav-item').forEach(el => {
                el.style.backgroundColor = ''; 
                if (!currentKeyword && (el.innerText.includes(currentCategory) || (currentCategory==='All' && el.innerText.includes('Home')))) {
                    el.style.backgroundColor = '#e6e9ea';
                }
            });
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText === currentSort) btn.classList.add('active');
            });

            container.innerHTML = '<p style="text-align:center; margin-top:20px;">Loading...</p>';

            try {
                let url = `/api/topic/list?sort=${currentSort}`;
                if (currentKeyword) url += `&keyword=${encodeURIComponent(currentKeyword)}`;
                else url += `&category=${currentCategory}`;

                const res = await fetch(url);
                const list = await res.json();
                
                container.innerHTML = "";
                if(list.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">No posts found.</div>'; return; }

                list.forEach(topic => {
                    const avatar = topic.author && topic.author.avatar ? topic.author.avatar : 'https://example.com/default.png';
                    const nickname = topic.author ? topic.author.nickname : 'u/Unknown';
                    const time = new Date(topic.createdAt).toLocaleDateString();
                    const votes = topic.voteCount || 0;

                    let mediaHtml = "";
                    if(topic.mediaList && topic.mediaList.length > 0) {
                        const m = topic.mediaList[0];
                        if(m.type==='VIDEO') mediaHtml=`<div class="media-preview"><video controls src="${m.url}"></video></div>`;
                        else mediaHtml=`<div class="media-preview"><img src="${m.url}"></div>`;
                    }

                    const div = document.createElement('div');
                    div.className = 'post-card';
                    div.onclick = (e) => {
                        if(e.target.tagName !== 'VIDEO' && e.target.className !== 'vote-btn') 
                            window.location.href = `topic_detail.html?id=${topic.id}`;
                    };

                    div.innerHTML = `
                        <div class="vote-column" onclick="event.stopPropagation()">
                            <div class="vote-btn up" onclick="vote(event, ${topic.id}, 1)">â‡§</div>
                            <div class="vote-count" id="vote-count-${topic.id}">${votes}</div>
                            <div class="vote-btn down" onclick="vote(event, ${topic.id}, -1)">â‡©</div>
                        </div>
                        <div class="content-column">
                            <div style="font-size:12px; color:#787c7e; margin-bottom:5px;">
                                <span style="font-weight:bold; color:black;">r/${topic.category || 'General'}</span>
                                â€¢ Posted by <a href="profile.html?id=${topic.author ? topic.author.id : 0}" style="font-weight:bold; hover:underline;">u/${nickname}</a> â€¢ ${time}
                            </div>
                            <div style="font-weight:bold; font-size:18px; margin-bottom:10px;">${topic.title}</div>
                            ${mediaHtml}
                            <div style="color:#1c1c1c; font-size:14px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">${topic.content || ''}</div>
                        </div>
                    `;
                    container.appendChild(div);
                });

            } catch(e) { console.error(e); }
        }

        checkLogin();
        loadFeed();
    </script>
</body>
</html>